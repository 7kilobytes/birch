#!/usr/bin/env bash
#
# birch - an irc client written in pure bash.

setup_terminal() {
    printf '\e[?1049h\e[?25l\e[2J\e[1;%sr' "$((LINES-1))"
    stty -echo
}

reset_terminal() {
    printf '\e[2J\e[;r\e[?25h\e[?1049l\e[;r'
    stty echo
}

get_term_size() {
    shopt -s checkwinsize; (:;:)
}

redraw() {
    printf '\e[2J\e[1;%sr' "$((LINES-1))"

    hist_arr="hist_${chan//[^a-zA-Z0-9=\\;]/_}"
    IFS=$'\n' read -d "" -ra hist <<< "${!hist_arr}"

    for ((i=${#hist[@]};i>0;i--)); {
        ((${#hist[@]}-i > LINES-1)) &&
            printf '%s\n' "${hist[-i]}"
    }
}

setup_irc() {
    exec 69>&-
    exec 69<>"/dev/tcp/${host}/6667" || {
        err+=("error: Couldn't connect to ${host}.")
        exit 1
    }

    printf 'NICK %s\n' "${user:-${USER}}" >&69
    printf 'USER %s 127.0.0.1 %s\n' "$USER $USER" "$HOSTNAME" >&69
    printf 'PASS %s\n' "$pass" >&69
    printf 'JOIN %s\n' "$chan" >&69
}

print_msg() {
    [[ $1 != "$nick" ]] &&
        local nick_color="\\e[38;5;${#1}m"

    printf -v msgs '\e[1m%b%s\e[m: %s\n' "$nick_color" "$1" "$2"
    printf '%s' "$msgs"

    # Log messages for history.
    declare -g "hist_${chan//[^a-zA-Z0-9=\\;]/_}+=${msgs}"
}

irc_receive() {
    read -srt "${1:-0.001}" -u 69 &&
        case "$REPLY" in
            PING*)
                printf 'PONG %s\n' "${REPLY/PING }" >&69
            ;;

            ":$host NICK"*)
                IFS=$' \r' read -r _ _ nick _ <<< "$REPLY"
            ;;

            :*"PRIVMSG $chan"*)
                IFS='!:' read -r _ user _ <<< "$REPLY"
                IFS=' :' read -r _ _ _ _ mesg <<< "${REPLY//::/$'\072\072'}"

                # Bold.
                mesg="${mesg/$'02'/$'\e[1m'}"
                mesg="${mesg/$''/$'\e[m'}"

                [[ -n $mesg ]] &&
                    print_msg "$user" "$mesg"
            ;;
        esac
}

irc_send() {
    read -rst 0.01 -n 1 -p $'\e7\e[999B\r\e[K'"$chan > $msg"$'\e[47m \e[m\e8' &&
        case "$REPLY" in
            $'\177'|$'\b')
                msg="${msg%?}"
            ;;

            "")
                case "$msg" in
                    '/join'*)
                        printf 'JOIN %s\n' "${msg/\/join }" >&69
                        chan="$_"
                        redraw
                    ;;

                    '/nick'*)
                        printf 'NICK %s\n' "${msg/\/nick }" >&69
                        nick="$_"
                    ;;

                    "") ;;

                    *)
                        printf 'PRIVMSG %s %s\n' "$chan" ":$msg" >&69
                        print_msg "$nick" "$msg"
                    ;;
                esac

                msg=
            ;;

            [[:print:]])
                msg+="$REPLY"
            ;;
        esac
}

get_args() {
    while getopts ":s:u:p:c:v" opt; do
        case "$opt" in
            's') host="$OPTARG" ;;
            'u') user="$OPTARG" ;;
            'p') pass="$OPTARG" ;;
            'c') chan="$OPTARG" ;;
            '?') usage ;;

            v)
                printf '%s\n' "birch 0.0.1"
                exit
            ;;

            :)
                printf '%s\n' "Option -$OPTARG requires an argument." >&2
                exit 1
            ;;
        esac
    done

    [[ -z $host ]] &&
        usage
}

usage() {
    printf '%s\n\t%s\n\t%s\n\t%s\n\t%s\n' \
        "usage: [birch -s host -u user -p pass -c channel]" \
        "-s server      Server to connect to." \
        "-u user        Username to use." \
        "-p password    Password to use." \
        "-c channel     Channel to join."
    exit 1
}

main() {
    get_args "$@"

    trap 'reset_terminal; printf "%s\n" "${err[@]}" >&2' EXIT
    trap 'get_term_size; redraw' WINCH

    get_term_size
    setup_terminal
    setup_irc

    for ((;;)); {
        irc_send
        irc_receive
    }
}

main "$@"
