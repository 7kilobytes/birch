#!/usr/bin/env bash
#
# birch - an irc client written in pure bash.

setup_terminal() {
    printf '\e[?1049h\e[?25l\e[2J\e[1;%sr' "$((LINES-1))"
    stty -echo
}

reset_terminal() {
    printf '\e[2J\e[;r\e[?25h\e[?1049l\e[;r'
    stty echo
}

get_term_size() {
    shopt -s checkwinsize; (:;:)
}

redraw() {
    hist="${1:-hist_${join:1}}"
    hist="${hist//[^a-zA-Z0-9\\;]/_}"
    printf '\e[2J\e[1;%sr%s' "$((LINES-1))" "${!hist}"
}

setup_irc() {
    exec 69>&-
    exec 69<>"/dev/tcp/${host}/6667" || {
        err+=("error: Couldn't connect to ${host}.")
        exit 1
    }

    printf 'NICK %s\n' "${user:-${USER}}" >&69
    printf 'USER %s 127.0.0.1 %s\n' "$USER $USER" "$HOSTNAME" >&69
    printf 'PASS %s\n' "$pass" >&69
    printf 'JOIN %s\n' "$join" >&69
}

print_msg() {
    [[ $1 != "$nick" ]] &&
        local nick_color="\\e[38;5;${#1}m"

    printf -v msgs '\e[1m%b%s\e[m: %s\n' "$nick_color" "$1" "$2"
    printf '%s' "$msgs"

    # Log channel history.
    hist_name="${join//[^a-zA-Z0-9\\;]/_}"
    declare -g "hist_${hist_name:1}+=${msgs}"
}

irc_receive() {
    while IFS='' read -srt "${1:-1}" -u 69; do
        case "$REPLY" in
            PING*)
                printf 'PONG %s\n' "${REPLY/PING }" >&69
            ;;

            ":$host NICK "*)
                read -r _ nick _ <<< "$REPLY"
            ;;

            :*"$join"*)
                IFS='!:' read -r _ user _ <<< "$REPLY"
                IFS=' :' read -r _ _ _ _ mesg <<< "${REPLY//::/$'\072\072'}"

                # Bold.
                mesg="${mesg/$'02'/$'\e[1m'}"
                mesg="${mesg/$''/$'\e[m'}"

                [[ -n $mesg ]] &&
                    print_msg "$user" "$mesg"
            ;;
        esac
    done
}

irc_send() {
    read -rst 0.1 -n 1 -p $'\e7\e[999B\r\e[K'"$nick $join > $msg"$'\e[47m \e[m\e8' &&
        case "$REPLY" in
            $'\177'|$'\b')
                msg="${msg%?}"
            ;;

            "")
                case "$msg" in
                    '/'*)
                        cmd="${msg/ *}"
                        cmd="${cmd:1}"
                        declare -g "${cmd}=${msg/\/${cmd} }"
                        printf '%s %s\n' "${cmd^^}" "${msg/\/${cmd} }" >&69

                        case "$cmd" in
                            # Print channel history.
                            join) redraw "hist_${msg/\/${cmd} \#}" ;;
                        esac
                    ;;

                    "") ;;

                    *)
                        printf 'PRIVMSG %s %s\n' "$join" ":$msg" >&69
                        print_msg "$nick" "$msg"
                    ;;
                esac

                msg=
            ;;

            [[:print:]])
                msg+="$REPLY"
            ;;
        esac
}

get_args() {
    while getopts ":s:u:p:c:v" opt; do
        case "$opt" in
            's') host="$OPTARG" ;;
            'u') user="$OPTARG" ;;
            'p') pass="$OPTARG" ;;
            'c') join="$OPTARG" ;;
            '?') usage ;;

            v)
                printf '%s\n' "birch 0.0.1"
                exit
            ;;

            :)
                printf '%s\n' "Option -$OPTARG requires an argument." >&2
                exit 1
            ;;
        esac
    done

    [[ -z $host ]] &&
        usage
}

usage() {
    printf '%s\n\t%s\n\t%s\n\t%s\n\t%s\n' \
        "usage: [birch -s host -u user -p pass -c channel]" \
        "-s server      Server to connect to." \
        "-u user        Username to use." \
        "-p password    Password to use." \
        "-c channel     Channel to join."
    exit 1
}

main() {
    get_args "$@"

    trap 'reset_terminal; printf "%s\n" "${err[@]}" >&2' EXIT
    trap 'get_term_size; redraw' WINCH

    get_term_size
    setup_terminal
    setup_irc
    irc_receive

    for ((;;)); {
        irc_send
        irc_receive 0.1 &
    }
}

main "$@"
