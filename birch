#!/usr/bin/env bash
#
# birch - an irc client written in pure bash.

setup_terminal() {
    printf '\e[?1049h\e[?25l\e[2J\e[1;%sr' "$((LINES-1))"
    stty -echo
}

reset_terminal() {
    printf '\e[2J\e[;r\e[?25h\e[?1049l'
    stty echo
}

get_term_size() {
    shopt -s checkwinsize; (:;:)
}

redraw() {
    printf '\e[2J\e[1;%sr' "$((LINES-1))"

    hist_arr="hist_${chan//[^a-zA-Z0-9=\\;]/_}"
    IFS=$'\n' read -d "" -ra hist <<< "${!hist_arr}"
    printf '%s\n' "${hist[@]: -$((LINES-1))}"
}

setup_irc() {
    exec 69>&-
    exec 69<>"/dev/tcp/${host}/6667" || exit 1

    printf 'NICK %s\n' "$nick" >&69
    printf 'USER %s - - :%s\n' "$nick" "$nick" >&69
    printf 'PASS %s\n' "$pass" >&69
    printf 'JOIN %s\n' "$chan" >&69
}

print_msg() {
    [[ $1 != "$nick" ]] &&
        local nick_color="\\e[38;5;${#2}m"

    printf -v msgs '\r\e[1m%b%s\e[m: %s\n' "$nick_color" "$2" "$3"
    printf '%s' "$msgs"
    hist_add "$msgs"
}

hist_add() {
    declare -g "hist_${chan//[^a-zA-Z0-9=\\;]/_}+=$1"
}

irc_receive() {
    read -srt "${1:-0.001}" -u 69 &&
        case "$REPLY" in
            PING*)
                printf 'PONG %s\n' "${REPLY/PING }" >&69
            ;;

            ":"*"$host NICK"*)
                IFS=$' \r' read -r _ _ nick _ <<< "$REPLY"
            ;;

            :*"PRIVMSG $chan"*)
                IFS='!:' read -r _ user _ <<< "$REPLY"
                IFS=' :' read -r _ _ _ _ mesg <<< "$REPLY"

                # Bold.
                mesg="${mesg/$'\00302\002'/$'\e[1m'}"
                mesg="${mesg/$'\003\002'/$'\e[m'}"

                [[ -n $mesg ]] &&
                    print_msg msg "$user" "$mesg"
            ;;

            *)
                printf '%s\n' "${REPLY/*:}"
                hist_add "${REPLY/*:}"
            ;;
        esac
}

irc_send() {
    printf '\e7\e[%sH\r\e[K%s\e[47m \e[m\e8' "$LINES" "$chan > $msg"

    read -rst 0.01 -n 1 &&
        case "$REPLY" in
            $'\177'|$'\b')
                msg="${msg%?}"
            ;;

            "")
                case "$msg" in
                    '/join'*)
                        printf 'JOIN %s\n' "${msg/\/join }" >&69
                        chan="$_"
                        redraw
                    ;;

                    '/nick'*)
                        printf 'NICK %s\n' "${msg/\/nick }" >&69
                        nick="$_"
                    ;;

                    "") ;;

                    *)
                        printf 'PRIVMSG %s %s\n' "$chan" ":$msg" >&69
                        print_msg msg "$nick" "$msg"
                    ;;
                esac

                msg=
            ;;

            [[:print:]])
                msg+="$REPLY"
            ;;
        esac
}

get_args() {
    while getopts ":s:u:p:c:v" opt; do
        case "$opt" in
            's') host="$OPTARG" ;;
            'u') nick="$OPTARG" ;;
            'p') pass="$OPTARG" ;;
            'c') chan="$OPTARG" ;;
            '?') usage ;;

            v)
                printf '%s\n' "birch 0.0.1"
                exit
            ;;

            :)
                printf '%s\n' "Option -$OPTARG requires an argument." >&2
                exit 1
            ;;
        esac
    done

    [[ -z $host || -z $nick ]] &&
        usage
}

usage() {
    printf '%s\n\t%s\n\t%s\n\t%s\n\t%s\n' \
        "usage: [birch -s host -u nick [-p pass -c channel]]" \
        "-s server      Server to connect to (required)." \
        "-u nick        Username to use (required)." \
        "-p password    Password to use." \
        "-c channel     Channel to join."
    exit 1
}

main() {
    get_args "$@"

    trap 'reset_terminal; exec 69>&-' EXIT
    trap 'get_term_size; redraw' WINCH

    get_term_size
    setup_terminal
    setup_irc

    for ((;;)); {
        irc_send
        irc_receive
    }
}

main "$@"
